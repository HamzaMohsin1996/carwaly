<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="./Assets/Css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha512-3M00D/rn8n+2ZVXBO9Hib0GKNpkm8MSUU/e2VNthDyBYxKWG+BftNYYcuEjXlyrSO637tidzMBXfE7sQm0INUg==" crossorigin="anonymous" referrerpolicy="no-referrer"/>
    <link rel="stylesheet" href="./Assets/Css/all.min.css">
    <link rel="stylesheet" href="./Assets/Css/owl.carousel.min.css">
    <link rel="stylesheet" href="./Assets/Css/owl.theme.default.min.css">
    <link rel="stylesheet" href="./Assets/Css/jquery-ui.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer"/>
    <!-- Custom CSS -->
    <link rel="stylesheet" href="./Assets/Css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/pose@0.8/dist/teachablemachine-pose.min.js"></script>
</head>

<body>
    <div id="leftwrapper">
        <div class="header">
            <h2>Gesture Bond</h2>
        </div>
        <div class="main-content-inner">
            <div class="container">
                <div class="main-content">
                    <div class="row w-100 custom-box-relative">
                        <div class="col-12">
                            <img src="./Assets/Images/male.gif" class="images active left-images" id="left-0">
                            <img src="./Assets/Images/hi-male.gif" class="images left-images" id="left-1">
                            <img src="./Assets/Images/thumbs-up-male.gif" class="images left-images" id="left-2">
                            <img src="./Assets/Images/hamza.gif" class="images left-images" id="left-3">
                            <img src="./Assets/Images/clap-male.gif" class="images left-images d-none" id="left-4">
                            <div>
                                <div class="d-none">
                                    <canvas id="canvas"></canvas>
                                </div>
                                <div id="label-container" class="d-flex mt-4 justify-content-lg-around d-none"></div>
                            </div>
                            <div class="custom-box-relative">
                                <div class="icons-wrapper">
                                    <div id="hearticon" class="bigheart d-none">
                                        <img src="./Assets/Images/Heartshape.png" alt="">
                                    </div>
                                    <div id="thumbsup" class="thumbsup d-none">
                                        <img src="./Assets/Images/GestureBond.png" alt="">
                                       
                                    </div>
                                    <div id="handup" class="handraised d-none">
                                        <img src="./Assets/Images/GestureBond1.png" alt="">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="footer-wrapper-new">
            <div class="button-container">
                <button id="end-call"><i class="fas fa-phone"></i></button>
                <button id="chat" class="center-button"><i class="fas fa-comment"></i></button>
            </div>
        </div>
    </div>

    <div class="sidebar-wrapper-new" id="sidebar">
        <div class="header-content">
            <div class="chat-header">
                <h5>Messages</h5>
                <button id="close-btn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="chat-messages">
                <!-- Messages will be displayed here -->
            </div>
            <div class="chat-footer">
                <textarea placeholder="Type your message..."></textarea>
                <button><i class="fa fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="./Assets/Js/jquery-3.5.1.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="./Assets/Js/popper.min.js"></script>
    <script src="./Assets/Js/bootstrap.bundle.min.js"></script>
    <script src="./Assets/Js/owl.carousel.min.js"></script>
    <script src="./Assets/Js/custom.js"></script>

    <script type="text/javascript">
        const sidebar = document.getElementById('sidebar');
        const chattogglebtn = document.getElementById('chat');
        const leftWrapper = document.getElementById('leftwrapper');
        const closeBtn = document.getElementById('close-btn');

        chattogglebtn.addEventListener('click', function () {
            sidebar.classList.toggle('active');
            leftWrapper.classList.toggle('active');
        });

        closeBtn.addEventListener('click', function () {
            sidebar.classList.remove('active');
            leftWrapper.classList.remove('active');
        });

        const URL = "https://teachablemachine.withgoogle.com/models/bzj7oGpfh/";
        let model, webcam, ctx, labelContainer, maxPredictions;

        async function init() {
            const modelURL = URL + "model.json";
            const metadataURL = URL + "metadata.json";

            // Load the model and metadata
            model = await tmPose.load(modelURL, metadataURL);
            maxPredictions = model.getTotalClasses();

            // Setup webcam
            const size = 200;
            const flip = true; // whether to flip the webcam
            webcam = new tmPose.Webcam(size, size, flip); // width, height, flip
            await webcam.setup(); // request access to the webcam
            await webcam.play();
            window.requestAnimationFrame(loop);

            // Append elements to the DOM
            const canvas = document.getElementById("canvas");
            canvas.width = size; 
            canvas.height = size;
            ctx = canvas.getContext("2d");
            labelContainer = document.getElementById("label-container");
            for (let i = 0; i < maxPredictions; i++) { // Add class labels
                labelContainer.appendChild(document.createElement("div"));
            }
        }

        async function loop(timestamp) {
            webcam.update(); // Update the webcam frame
            await predict();
            window.requestAnimationFrame(loop);
        }

        async function predict() {
            // Prediction #1: run input through posenet
            const { pose, posenetOutput } = await model.estimatePose(webcam.canvas);
            // Prediction #2: run input through teachable machine classification model
            const prediction = await model.predict(posenetOutput);

            let maxClassIndex = -1;
            let maxClassProbability = 0;

            // Mapping of class names to their corresponding image IDs
            const classToImageMap = {
                "Hands Up": "left-1",
                "Thumbs Up": "left-2",
                "Heart Shape": "left-3",
                "No Gesture": "left-0",
            };

            const classToBodyClassMap = {
                "Hands Up": "hand-raised",
                "Thumbs Up": "thumbs-up",
                "Heart Shape": "heart-shape",
                "No Gesture": "no-gesture",
            };

            console.log(prediction); // Log predictions for debugging

            for (let i = 0; i < maxPredictions; i++) {
                const classPrediction = prediction[i].className + ": " + prediction[i].probability.toFixed(2);
                labelContainer.childNodes[i].innerHTML = classPrediction;

                // Check if the current class has the highest probability
                if (prediction[i].probability > maxClassProbability) {
                    maxClassProbability = prediction[i].probability;
                    maxClassIndex = i;
                }
            }

            // Only consider a gesture valid if its probability is above 0.75
            if (maxClassIndex !== -1 && maxClassProbability > 0.75) {
                const activeClassName = prediction[maxClassIndex].className;
                const activeImageId = classToImageMap[activeClassName];
                const activeBodyClass = classToBodyClassMap[activeClassName];

                if (activeImageId) {
                    document.body.className = activeBodyClass;
                    for (let i = 0; i < 4; i++) { // We have 4 images, update the loop range
                        const imageElement = document.getElementById(`left-${i}`);
                        if (`left-${i}` === activeImageId) {
                            imageElement.classList.add('active');
                        } else {
                            imageElement.classList.remove('active');
                        }
                    }
                }
            } else {
                // If no class probability is greater than 0.75, ensure the default image is active
                document.body.className = "no-gesture";
                for (let i = 0; i < 4; i++) { // We have 4 images, update the loop range
                    const imageElement = document.getElementById(`left-${i}`);
                    if (i === 0) {
                        imageElement.classList.add('active');
                    } else {
                        imageElement.classList.remove('active');
                    }
                }
            }

            // Draw the pose on the canvas
            drawPose(pose);
        }

        function drawPose(pose) {
            if (webcam.canvas) {
                ctx.drawImage(webcam.canvas, 0, 0);
                // Draw the keypoints and skeleton
                if (pose) {
                    const minPartConfidence = 0.75;
                    tmPose.drawKeypoints(pose.keypoints, minPartConfidence, ctx);
                    tmPose.drawSkeleton(pose.keypoints, minPartConfidence, ctx);
                }
            }
        }

        window.addEventListener("load", init);
    </script>
</body>
</html>
